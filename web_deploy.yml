---
- name: Install web server, insert an index page, verify service is started and that the index page appears
  hosts: "{{ vm_name | default('none') }}"
  gather_facts: true

  tasks:
    - name: RHEL Apache config
      ansible.builtin.include_role:
        name: webserver_basic
      when: ansible_os_family == "RedHat"
      tags:
        - always

    - name: Windows IIS config
      ansible.builtin.include_role:
        name: webserver_basic
      when: ansible_os_family == "Windows"
      tags:
        - always

  post_tasks:
    - name: Check that you can connect to the index page and that the hostname is in the contents
      ansible.builtin.uri:
        url: http://{{ inventory_hostname }}
        validate_certs: false
        return_content: true
      register: this
      failed_when: inventory_hostname not in this.content
      when: ansible_os_family == "RedHat"
      tags:
        - updaterhel

    - name: Check that you can connect to the index page and that the hostname is in the contents
      ansible.windows.win_uri:
        url: http://{{ inventory_hostname }}
        validate_certs: false
        return_content: true
      register: this
      failed_when: inventory_hostname not in this.content
      when: ansible_os_family == "Windows"
      tags:
        - updatewin

    - name: Print web address
      ansible.builtin.debug:
        msg: Web address is https://{{ inventory_hostname }}
